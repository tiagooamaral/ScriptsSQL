Select ESTMVVD1.*, ESTMVVD5.*,
ALM_EMIT.ALM_FANT, ALM_EMIT.ALM_NOM, ALM_EMIT.ALM_CGC, ALM_EMIT.ALM_IES, ALM_EMIT.ALM_IM,
ALM_EMIT.ALM_TEL, ALM_EMIT.ALM_CEP, ALM_EMIT.ALM_END, ALM_EMIT.ALM_NUM, ALM_EMIT.ALM_BAI, ALM_EMIT.ALM_CID,
ALM_EMIT.ALM_EST, ALM_EMIT.ALM_NFE_CERTIFICADO, ALM_EMIT.ALM_NFE_AMBIENTE, ALM_EMIT.ALM_NFE_FORMA_EMISSAO,
TRA_NOM, TRA_INF, TRA_NRCASASDEC_PRO, TRA_NRCASASDEC_PRECO_PRO,
ALM_EMIT.ALM_TRIB_SIMPLES, ALM_EMIT.ALM_SIMPLES_CRED_ICMS, ALM_EMIT.DAT_ATU AS DATA_SCAN,
COALESCE(TRA_OBS1_CUP, 'OBS1') AS TRA_OBS1_CUP,    COALESCE(TRA_OBS2_CUP, 'OBS2') AS TRA_OBS2_CUP,
COALESCE(TRA_OBS3_CUP, 'OBS3') AS TRA_OBS3_CUP,    COALESCE(TRA_OBS4_CUP, 'OBS4') AS TRA_OBS4_CUP,
TRA_DIGITA_ICMS, TRA_DIGITA_IPI,    CFO_NOM, CFO_CFO, CFO_MSG1, CFO_MSG2, CFO_MSG3, CFO_MSG4, CFO_MSG5,
CLIENTE.CLI_RED, CLIENTE.CLI_NOM, CLIENTE.CLI_TEL, CLIENTE.CLI_EMA, CLIENTE.EMA_ENT, CLIENTE.CLI_SIMPLES_NACIONAL,
CLIENTE.NOM_ENT, CLIENTE.CGC_ENT, CLIENTE.END_ENT, CLIENTE.NUM_ENT, CLIENTE.COM_ENT, CLIENTE.BAI_ENT, CLIENTE.CID_ENT,
CLIENTE.EST_ENT, CLIENTE.CEP_ENT,    LEASING.CLI_RED LEASING_RED, LEASING.CLI_NOM LEASING_NOM, LEASING.CLI_TEL
 LEASING_TEL, LEASING.CLI_EMA LEASING_EMA, LEASING.EMA_ENT LEASING_EMA_ENT,
 FOR_RED, FOR_RZS, FOR_TEL, FOR_EMA,
  ALM_TRANSF.ALM_FANT TRANSF_FANT, ALM_TRANSF.ALM_NOM TRANSF_NOM, ALM_TRANSF.ALM_TRIB_SIMPLES TRANSF_SIMPLES,
  ALM_TRANSF.ALM_CGC TRANSF_CGC, ALM_TRANSF.ALM_IES TRANSF_IES,
  ALM_TRANSF.ALM_LOG TRANSF_LOG, ALM_TRANSF.ALM_END TRANSF_END,
  ALM_TRANSF.ALM_NUM TRANSF_NUM, ALM_TRANSF.ALM_COP TRANSF_COP,
  ALM_TRANSF.ALM_BAI TRANSF_BAI, ALM_TRANSF.ALM_CID TRANSF_CID,
  ALM_TRANSF.ALM_EST TRANSF_EST, ALM_TRANSF.ALM_CEP TRANSF_CEP, ALM_TRANSF.ALM_TEL TRANSF_TEL,
  TRS_RED, TRS_NOM, TRS_CGC, TRS_IES, TRS_TE1, TRS_CEP,
  TRS_END, TRS_NUM, TRS_COP, TRS_BAI, TRS_CID, TRS_EST,
  NFE_ID, NFE_STATUS, NFE_ARQUIVO, NFE_RESPOSTA,    (SELECT MAX(OUTROS)
  FROM CDIMPRESO, CDFORM, CDTRA3
 WHERE CDFORM.FORM_COD = CDTRA3.TRA_FORM
   AND CDFORM.FORM_ALM = ALM_EMIT.ALM_COD
   AND CDTRA3.TRA_TRA = CDTRA1.TRA_COD
   AND CDFORM.FORM_IMPRESSO = CDIMPRESO.NOME
   AND CDIMPRESO.CAMPO_INT = 'Modelo_de_Danfe'    ) MODELO,
       (SELECT SERIE_NUMERO       FROM CDSERIENF, CDFORM, CDTRA3      WHERE CDFORM.FORM_COD = CDTRA3.TRA_FORM
           AND CDFORM.FORM_ALM = ALM_EMIT.ALM_COD
           AND CDTRA3.TRA_TRA = CDTRA1.TRA_COD
           AND CDFORM.FORM_SERIE = CDSERIENF.SERIE_COD    ) SERIE_NUMERO,
     (Select RESULT From LISTAR_CUPONS_RELACIONADOS(ESTMVVD1.VD1_COD)) LANCAMENTOS,
      CDTRANFE.TRA_DEVOLUCAO, ALM_EMIT.ALM_NFE_FOTO From ESTMVVD1
      Left join CDALM ALM_EMIT on (CDALM.ALM_COD = ESTMVVD1.VD1_ALM)
      Left join CDTRA1 on (CDTRA1.TRA_COD = ESTMVVD1.VD1_TRA)
      Left join CDCFO on (CDCFO.CFO_COD = ESTMVVD1.VD1_CFOP)
      Left join CDCLI CLIENTE on (CLIENTE.CLI_COD = ESTMVVD1.VD1_CLI)
      Left join CDCLI LEASING on (LEASING.CLI_COD = ESTMVVD1.VD1_CLI_LEASING)
      Left join CDFOR on (CDFOR.FOR_COD = ESTMVVD1.VD1_FOR)
      Left join CDTRS on (CDTRS.TRS_COD = ESTMVVD1.VD1_TRS)
      Left join CDALM ALM_TRANSF on (ALM_TRANSF.ALM_COD = ESTMVVD1.VD1_ALM_TRANSF)
      Left join ESTMVVD5 on (ESTMVVD5.VD5_BOL = ESTMVVD1.VD1_COD AND (ESTMVVD5.VD5_TIP <> 'ENT') AND
        ((COALESCE(ESTMVVD1.VD1_CLI,0) = 0) OR (ESTMVVD5.VD5_TIP = 'FAT')))
      Left join MVNFE on (MVNFE.NFE_VD1 = ESTMVVD1.VD1_COD)
      Left join CDTRANFE on (CDTRANFE.TRA_TRA = CDTRA1.TRA_COD)
Where VD1_COD ='0000040894001'
