ALTER PROCEDURE SEQUENCIA_NF_PROD (
    DATA_DE TIMESTAMP,
    DATA_ATE TIMESTAMP)
RETURNS ( 
    VD1_NOT DOUBLE PRECISION,
    FORM_NOM VARCHAR(45),
    CLI_RED VARCHAR(75),
    CLI_NOM VARCHAR(60),
    NOM_ENT VARCHAR(75),
    VD1_QUANTIDADE DOUBLE PRECISION,
    ALM_NOM VARCHAR(50),
    VD1_CAD TIMESTAMP,
    VD1_VALOR_TOTALL DOUBLE PRECISION,
    VD1_VALOR_ICMS DOUBLE PRECISION,
    VD1_COD VARCHAR(13),
    VD1_CFOP INTEGER,
    CFO_CFO VARCHAR(20),
    VD1_CANC VARCHAR(2),
    CFO_NOM VARCHAR(100),
    SERIE_NOM VARCHAR(5),
    STATUS VARCHAR(20),
    PGT_NOM VARCHAR(100),
    VD1_VALOR_TOTALB DOUBLE PRECISION)
 AS
declare variable voldn double precision;
 declare variable voldalm varchar(50);
 declare variable vvez integer;
 declare variable tvd1_not double precision;
 declare variable tform_nom varchar(45);
 declare variable tcli_red varchar(75);
 declare variable tcli_nom varchar(60);
 declare variable tnom_ent varchar(75);
 declare variable tvd1_quantidade double precision;
 declare variable talm_nom varchar(50);
 declare variable tvd1_cad date;
 declare variable tvd1_valor_totall double precision;
 declare variable tvd1_valor_icms double precision;
 declare variable tvd1_cod varchar(13);
 declare variable tvd1_cfop integer;
 declare variable tcfo_cfo varchar(20);
 declare variable tvd1_canc varchar(2);
 declare variable tcfo_nom varchar(100);
 declare variable tserie_nom varchar(5);
 declare variable tstatus varchar(20);
 declare variable tpgt_nom varchar(100);
 declare variable tvd1_valor_totalb double precision;
 BEGIN
 vOLDN = 0;
 vOLDALM = '';
 vVEZ = 0;
 FOR
 SELECT DISTINCT VD1_NOT, FORM_NOM,
 CASE WHEN (VD1_CLI <> 0) THEN CLI_RED WHEN (VD1_FOR <> 0) THEN FOR_RED ELSE 'SEM ENTIDADE' END,
 CASE WHEN (VD1_CLI <> 0) THEN NOM_ENT WHEN (VD1_FOR <> 0) THEN FOR_RZS ELSE 'SEM ENTIDADE' END, VD1_QUANTIDADE, ALM_NOM, VD1_CAD, VD1_TOTALL_PRODUTO,
 VD1_VALOR_ICMS, VD1_COD, VD1_CFOP, CFO_CFO, VD1_CANC, CFO_NOM, SERIE_NOM,
 STATUS, PGT_NOM, VD1_TOTALB_PRODUTO, CLI_NOM
 FROM CDFORM, CDALM, ESTMVVD1
 INNER JOIN CDSTATUS ON (CDSTATUS.STA_SIG = ESTMVVD1.VD1_CANC)
 LEFT JOIN CDPRESTSER ON (ESTMVVD1.VD1_PRESTSER = PRE_COD)
 LEFT JOIN CDCLI ON (ESTMVVD1.VD1_CLI = CLI_COD)
 LEFT JOIN CDFOR ON (ESTMVVD1.VD1_FOR = FOR_COD)
 LEFT JOIN CDPRESTSER ON (ESTMVVD1.VD1_PRESTSER = PRE_COD)
 LEFT JOIN ESTMVVD3 ON (ESTMVVD1.VD1_COD=VD3_BOL)
 LEFT JOIN CDPGT ON (ESTMVVD3.VD3_PGT=PGT_COD)
 LEFT JOIN CDCFO ON (ESTMVVD1.VD1_CFOP=CFO_COD), CDSERIENF, CDTRA1, CDTRA3
 WHERE VD1_ALM = ALM_COD
 AND TRA_COD = VD1_TRA
 AND CDTRA1.TRA_COD = CDTRA3.TRA_TRA
 AND CDTRA3.TRA_FORM = CDFORM.FORM_COD
 and cdform.form_alm = cdalm.alm_cod
 AND FORM_SERIE = SERIE_COD
 AND (TRA_LAY_PDV = "PRO" OR TRA_LAY_PDV = "PS")
 AND FORM_IMPRESSO IN (SELECT NOME FROM CDIMPRESO WHERE TIPOFORM = 'NFP' or TIPOFORM = 'NFE')
 AND ( (ESTMVVD1.VD1_CAD >= :DATA_DE) OR (:DATA_DE IS NULL) )
 AND ( (ESTMVVD1.VD1_CAD <= :DATA_ATE) OR (:DATA_ATE IS NULL) )
 AND ( (STA_SIG='P')
 OR (STA_SIG='F')
 OR (STA_SIG='FN')
 OR (STA_SIG='C') )
 ORDER BY ALM_NOM, SERIE_NOM ASC, VD1_NOT
 INTO VD1_NOT, FORM_NOM, CLI_RED, NOM_ENT, VD1_QUANTIDADE,
 ALM_NOM, VD1_CAD, VD1_VALOR_TOTALL, VD1_VALOR_ICMS, VD1_COD,
 VD1_CFOP, CFO_CFO, VD1_CANC, CFO_NOM, SERIE_NOM, STATUS,
 PGT_NOM, VD1_VALOR_TOTALB, CLI_NOM DO
 BEGIN

 IF ((vVEZ = 0) OR (vOLDALM <> ALM_NOM) OR (vOLDN = 0) OR ( vOLDN>VD1_NOT)) THEN
 BEGIN
 vOLDN = VD1_NOT;
 vOLDALM = ALM_NOM;
 vVEZ = 1;
 END

 IF ((VD1_NOT > 0) AND (vOLDN <= VD1_NOT)) THEN
 BEGIN
 tVD1_NOT = VD1_NOT;
 tFORM_NOM = FORM_NOM;
 tCLI_RED = CLI_RED;
 tCLI_NOM = CLI_NOM;
 tNOM_ENT = NOM_ENT;
 tVD1_QUANTIDADE = VD1_QUANTIDADE;
 tALM_NOM = ALM_NOM;
 tVD1_CAD = VD1_CAD;
 tVD1_VALOR_TOTALL = VD1_VALOR_TOTALL;
 tVD1_VALOR_ICMS = VD1_VALOR_ICMS;
 tVD1_COD = VD1_COD;
 tVD1_CFOP = VD1_CFOP;
 tCFO_CFO = CFO_CFO;
 tVD1_CANC = VD1_CANC;
 tCFO_NOM = CFO_NOM;
 tSERIE_NOM = SERIE_NOM;
 tSTATUS = STATUS;
 tPGT_NOM = PGT_NOM;
 TVD1_VALOR_TOTALB = VD1_VALOR_TOTALB;

 WHILE ((vOLDN < tVD1_NOT) AND (vOLDALM = ALM_NOM)) DO
 BEGIN
 VD1_NOT = vOLDN;
 FORM_NOM = '*NÃƒO IMPRESSA OU CANCELADA';
 CLI_RED = '*NÃƒO IMPRESSA OU CANCELADA';
 CLI_NOM = '*NÃƒO IMPRESSA OU CANCELADA';
 NOM_ENT = '*NÃƒO IMPRESSA OU CANCELADA';
 VD1_QUANTIDADE = NULL;
 VD1_VALOR_TOTALL = NULL;
 VD1_VALOR_ICMS = NULL;
 VD1_COD = NULL;
 VD1_CFOP = NULL;
 CFO_CFO = NULL;
 VD1_CANC = NULL;
 CFO_NOM = NULL;
 SERIE_NOM = SERIE_NOM;
 VD1_VALOR_TOTALB = NULL;
 STATUS = NULL;
 SUSPEND;
 vOldN = vOldN + 1;
 END

 VD1_NOT = tVD1_NOT;
 FORM_NOM = tFORM_NOM;
 CLI_RED = tCLI_RED;
 CLI_NOM = tCLI_NOM;
 NOM_ENT = tNOM_ENT;
 VD1_QUANTIDADE = tVD1_QUANTIDADE;
 ALM_NOM = tALM_NOM;
 VD1_CAD = tVD1_CAD;
 VD1_VALOR_TOTALL = tVD1_VALOR_TOTALL;
 VD1_VALOR_ICMS = tVD1_VALOR_ICMS;
 VD1_COD = tVD1_COD;
 VD1_CFOP = tVD1_CFOP;
 CFO_CFO = tCFO_CFO;
 VD1_CANC = tVD1_CANC;
 CFO_NOM = tCFO_NOM;
 SERIE_NOM = tSERIE_NOM;
 STATUS = tSTATUS;
 PGT_NOM = tPGT_NOM;
 VD1_VALOR_TOTALB = TVD1_VALOR_TOTALB;

 SUSPEND;
 vOldN = vOldN + 1;
 END
 ELSE
 IF (VD1_NOT = 0) THEN
 BEGIN
 SUSPEND;
 END
 ELSE
 BEGIN
 SUSPEND;
 vOldN = vOldN + 1;
 END
 END

 END